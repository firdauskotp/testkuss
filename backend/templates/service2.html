{% extends "base.html" %}

{% block title %}Service Form{% endblock %}
{% block page_title %}Service Report{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
    <style>
      .signature-pad-container {
        border: 1px solid #e5e7eb; /* Tailwind gray-200 */
        border-radius: 0.375rem; /* Tailwind rounded-md */
        width: 100%;
        height: 200px;
        position: relative;
        touch-action: none;
      }
      .dark .signature-pad-container {
        border-color: #4b5563; /* Tailwind dark:border-gray-600 */
      }
      canvas.signature-pad {
        width: 100%;
        height: 100%;
        border-radius: 0.375rem; /* Tailwind rounded-md */
      }
    </style>
{% endblock %}

{% block content %}
<div class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto space-y-8">

        <div class="text-left mb-6">
            <a href="{{ url_for('dashboard') }}"
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                &larr; Back to Dashboard
            </a>
        </div>

        {# Assuming the action for this form is the 'service' endpoint, adjust if it's different like 'service2_submit' #}
        <form method="POST" action="{{ url_for('forms.service2') }}" class="space-y-8" {# Check if action should be different, e.g. /service-simple #}
              data-get-premises-url-template="{{ url_for('api_helpers.get_premises', company='__COMPANY_ID__') }}"
              data-get-client-details-url-template="{{ url_for('api_helpers.get_client_details', premise_name='__PREMISE_ID__') }}"
              data-get-device-details-url-template="{{ url_for('api_helpers.get_device_details', premise_name='__PREMISE_ID__') }}"
              data-get-models-url-template="{{ url_for('api_helpers.get_models', premise='__PREMISE_ID__') }}"
              data-get-colors-url-template="{{ url_for('api_helpers.get_colors', model='__MODEL_ID__', premise='__PREMISE_ID__') }}"
              data-get-eo-url-template="{{ url_for('api_helpers.get_eo', model='__MODEL_ID__', premise='__PREMISE_ID__', color='__COLOR_ID__') }}">

            <!-- Technician Info -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Technician Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Technician Name</label>
                        <input type="text" value="{{ technician_name }}" readonly
                               class="tailwind-input-class bg-gray-100 dark:bg-gray-700 cursor-not-allowed text-gray-500 dark:text-gray-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date and Time</label>
                        <input type="text" value="{{ current_time }}" readonly
                               class="tailwind-input-class bg-gray-100 dark:bg-gray-700 cursor-not-allowed text-gray-500 dark:text-gray-400">
                    </div>
                </div>
            </div>

            <!-- Client & Device Identification -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Client & Device</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="company" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company</label>
                        <select id="company" name="company" required class="tailwind-input-class">
                            <option value="" selected disabled>Select a company</option>
                            {% for c_item in companies %} <option value="{{ c_item }}">{{ c_item }}</option> {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="premise" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Premise</label>
                        <select id="premise" name="premise" required disabled class="tailwind-input-class disabled-tailwind-input-class">
                            <option value="" selected disabled>Select a premise</option>
                        </select>
                    </div>
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                        <select id="model" name="model" required disabled class="tailwind-input-class disabled-tailwind-input-class">
                            <option value="" selected disabled>Select a model</option>
                        </select>
                    </div>
                    <div>
                        <label for="color" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color</label>
                        <select id="color" name="color" required disabled class="tailwind-input-class disabled-tailwind-input-class">
                            <option value="" selected disabled>Select a color</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="eo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">EO (Essential Oil)</label>
                        <select id="eo" name="eo" required disabled class="tailwind-input-class disabled-tailwind-input-class">
                            <option value="" selected disabled>Select an EO</option>
                        </select>
                    </div>
                </div>
                 <!-- Client and Device Details (auto-filled by JS) -->
                <div id="client-details" class="mt-4 text-sm text-gray-600 dark:text-gray-400"></div>
                <div id="device-details" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
            </div>

            <!-- Acknowledgement -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Acknowledgement</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Actions Done:</label>
                        <div class="space-y-2">
                            {% for action_val, action_text in [
                                ('Alcohol Cleaning', 'Alcohol Cleaning'),
                                ('Oil Refill', 'Oil Refill'),
                                ('Checked Timer Settings', 'Checked Timer Settings'),
                                ('Replaced Straw/ Mist Head', 'Replaced Straw/ Mist Head'),
                                ('Replaced Batteries', 'Replaced Batteries'),
                                ('Replaced Faulty Machine', 'Replaced Faulty Machine')
                            ] %}
                            <div class="flex items-center">
                                <input id="action_{{ loop.index }}" name="actions" value="{{ action_val }}" type="checkbox"
                                       class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                                <label for="action_{{ loop.index }}" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">{{ action_text }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div>
                        <label for="remarks" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Remarks:</label>
                        <textarea name="remarks" id="remarks" rows="3" class="tailwind-input-class"></textarea>
                    </div>
                    <div>
                        <label for="staffName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Staff Name:</label>
                        <input type="text" name="staffName" id="staffName" required class="tailwind-input-class">
                    </div>
                    <div>
                        <label for="signature" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Signature:</label>
                        <div class="signature-pad-container">
                            <canvas id="signature-pad" class="signature-pad"></canvas>
                        </div>
                        <input type="hidden" name="signature" id="signature-input">
                        <button type="button" id="clear-signature"
                                class="mt-2 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                            Clear Signature
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button type="submit"
                        class="py-2.5 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white
                               bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600
                               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-900">
                    Submit Service
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Common Tailwind class for JS-generated elements or direct styling if needed
    const tailwindInputClass = "appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50";
    const disabledTailwindInputClass = "disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:text-gray-400 dark:disabled:text-gray-500 cursor-not-allowed";

    // Apply disabled styles to selects that start as disabled
    document.querySelectorAll('select[disabled]').forEach(el => {
        el.classList.add(...disabledTailwindInputClass.split(' '));
    });

    // SignaturePad logic
    const canvas = document.getElementById("signature-pad");
    const signaturePad = new SignaturePad(canvas, {
        minWidth: 1,
        maxWidth: 2.5,
        penColor: document.documentElement.getAttribute('data-theme') === 'dark' ? "white" : "black"
    });

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    document.getElementById("clear-signature").addEventListener("click", () => {
        signaturePad.clear();
    });

    document.querySelector("form").addEventListener("submit", function (event) {
        if (!signaturePad.isEmpty()) {
            document.getElementById("signature-input").value = signaturePad.toDataURL("image/png");
        }
    });

    if (window.matchMedia) {
      const mediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');
      mediaQueryList.addEventListener('change', event => {
        signaturePad.penColor = event.matches ? "white" : "black";
        signaturePad.clear();
      });
    }

    // Dependent dropdown logic (similar to pre-service.html)
    const service2Form = document.querySelector('form[action="{{ url_for("forms.service2") }}"]');
    const getPremisesUrlTemplate = service2Form.dataset.getPremisesUrlTemplate;
    const getClientDetailsUrlTemplate = service2Form.dataset.getClientDetailsUrlTemplate;
    const getDeviceDetailsUrlTemplate = service2Form.dataset.getDeviceDetailsUrlTemplate;
    const getModelsUrlTemplate = service2Form.dataset.getModelsUrlTemplate;
    const getColorsUrlTemplate = service2Form.dataset.getColorsUrlTemplate;
    const getEoUrlTemplate = service2Form.dataset.getEoUrlTemplate;

    const companyDropdown = document.getElementById('company');
    const premiseDropdown = document.getElementById('premise');
    const modelDropdown = document.getElementById('model');
    const colorDropdown = document.getElementById('color');
    const eoDropdown = document.getElementById('eo');
    const clientDetailsDiv = document.getElementById('client-details');
    const deviceDetailsDiv = document.getElementById('device-details');


    const allDynamicDropdowns = [premiseDropdown, modelDropdown, colorDropdown, eoDropdown];

    function resetAndDisableDynamicDropdowns(dropdowns) {
        dropdowns.forEach(dd => {
            if (dd) { // Check if element exists
                dd.innerHTML = `<option value="" selected disabled>Select...</option>`; // Generic placeholder
                dd.disabled = true;
                dd.classList.add(...disabledTailwindInputClass.split(' '));
            }
        });
    }

    if(companyDropdown) {
        companyDropdown.addEventListener('change', function() {
            const companyId = this.value;
            resetAndDisableDynamicDropdowns(allDynamicDropdowns);
            if(clientDetailsDiv) clientDetailsDiv.innerHTML = '';
            if(deviceDetailsDiv) deviceDetailsDiv.innerHTML = '';

            if (!companyId) return;

            axios.get(getPremisesUrlTemplate.replace('__COMPANY_ID__', encodeURIComponent(companyId)))
                .then(response => {
                    premiseDropdown.innerHTML = '<option value="" selected disabled>Select a premise</option>';
                     if (response.data && Array.isArray(response.data.premises)) {
                         response.data.premises.forEach(p => {
                            premiseDropdown.innerHTML += `<option value="${p}">${p}</option>`;
                        });
                    } else if (response.data && Array.isArray(response.data)) {
                         response.data.forEach(p => {
                            premiseDropdown.innerHTML += `<option value="${p}">${p}</option>`;
                        });
                    }
                    premiseDropdown.disabled = false;
                    premiseDropdown.classList.remove(...disabledTailwindInputClass.split(' '));
                })
                .catch(error => console.error('Error fetching premises:', error));
        });
    }

    if(premiseDropdown) {
        premiseDropdown.addEventListener('change', function() {
            const premiseId = this.value;
            resetAndDisableDynamicDropdowns([modelDropdown, colorDropdown, eoDropdown]);
            if(clientDetailsDiv) clientDetailsDiv.innerHTML = ''; // Clear previous details
            if(deviceDetailsDiv) deviceDetailsDiv.innerHTML = '';

            if (!premiseId) return;

            // Fetch and display client details
            axios.get(getClientDetailsUrlTemplate.replace('__PREMISE_ID__', encodeURIComponent(premiseId)))
                .then(response => {
                    if(clientDetailsDiv) clientDetailsDiv.innerHTML = response.data.html; // Assuming endpoint returns HTML
                })
                .catch(error => console.error('Error fetching client details:', error));

            // Fetch and display device details (simplified, might need more complex rendering)
            axios.get(getDeviceDetailsUrlTemplate.replace('__PREMISE_ID__', encodeURIComponent(premiseId)))
                .then(response => {
                    if(deviceDetailsDiv) deviceDetailsDiv.innerHTML = response.data.html; // Assuming endpoint returns HTML
                })
                .catch(error => console.error('Error fetching device details:', error));


            // Populate model dropdown (example, actual endpoint might differ)
            axios.get(getModelsUrlTemplate.replace('__PREMISE_ID__', encodeURIComponent(premiseId)))
                .then(response => {
                    modelDropdown.innerHTML = '<option value="" selected disabled>Select a model</option>';
                    if (response.data && Array.isArray(response.data)) {
                        response.data.forEach(m => {
                            modelDropdown.innerHTML += `<option value="${m}">${m}</option>`;
                        });
                    }
                    modelDropdown.disabled = false;
                    modelDropdown.classList.remove(...disabledTailwindInputClass.split(' '));
                })
                .catch(error => console.error('Error fetching models:', error));
        });
    }
    
    if(modelDropdown) {
        modelDropdown.addEventListener('change', function() {
            const modelId = this.value;
            const premiseId = premiseDropdown.value;
            resetAndDisableDynamicDropdowns([colorDropdown, eoDropdown]);
            if (!modelId || !premiseId) return;

            axios.get(getColorsUrlTemplate.replace('__MODEL_ID__', encodeURIComponent(modelId)).replace('__PREMISE_ID__', encodeURIComponent(premiseId)))
                .then(response => {
                    colorDropdown.innerHTML = '<option value="" selected disabled>Select a color</option>';
                     if (response.data && Array.isArray(response.data)) {
                        response.data.forEach(c => {
                            colorDropdown.innerHTML += `<option value="${c}">${c}</option>`;
                        });
                    }
                    colorDropdown.disabled = false;
                    colorDropdown.classList.remove(...disabledTailwindInputClass.split(' '));
                })
                .catch(error => console.error('Error fetching colors:', error));
        });
    }

    if(colorDropdown) {
        colorDropdown.addEventListener('change', function() {
            const colorId = this.value;
            const modelId = modelDropdown.value;
            const premiseId = premiseDropdown.value;
            resetAndDisableDynamicDropdowns([eoDropdown]);
            if (!colorId || !modelId || !premiseId) return;

            axios.get(getEoUrlTemplate.replace('__MODEL_ID__', encodeURIComponent(modelId)).replace('__PREMISE_ID__', encodeURIComponent(premiseId)).replace('__COLOR_ID__', encodeURIComponent(colorId)))
                .then(response => {
                    eoDropdown.innerHTML = '<option value="" selected disabled>Select an EO</option>';
                    if (response.data && Array.isArray(response.data)) {
                        response.data.forEach(e => {
                            eoDropdown.innerHTML += `<option value="${e}">${e}</option>`;
                        });
                    }
                    eoDropdown.disabled = false;
                    eoDropdown.classList.remove(...disabledTailwindInputClass.split(' '));
                })
                .catch(error => console.error('Error fetching EO:', error));
        });
    }

</script>
{% endblock %}
