{% extends "base.html" %}

{% block title %}Device Master List{% endblock %}
{% block page_title %}Device Master List{% endblock %}

{% block head_extra %}
    {# Any page-specific CSS or JS links for this page #}
{% endblock %}

{% block content %}
<div class="py-8 px-4 sm:px-6 lg:px-8 space-y-8">

    <div class="flex justify-start mb-6">
        <a href="{{ url_for('dashboard') }}"
           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
            &larr; Back to Dashboard
        </a>
    </div>

    <!-- Filter Form Section -->
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
        <button id="filterToggleButton"
                class="w-full flex justify-between items-center py-3 px-4 text-left text-lg font-semibold text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700/50 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <span>Show/Hide Filters for Devices</span>
            <svg id="filterToggleIcon" class="w-5 h-5 transform transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div id="filterFormContainer" class="hidden mt-6">
            <form method="get" action="{{ url_for('data_reports.device_master_list') }}" class="space-y-6"> {# Assuming 'view_device' is the filter endpoint #}
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-6 gap-y-4">
                    {% for name, label, placeholder, type in [
                        ('company', 'Company', 'Company A', 'text'),
                        ('tied_to_premise', 'Tied to Premise', 'Premise A', 'text'),
                        ('location', 'Location', 'Toilet', 'text'),
                        ('sn', 'Serial Number', '123', 'number'),
                        ('model', 'Model', 'VOX', 'text'),
                        ('color', 'Color', 'B', 'text'),
                        ('current_eo', 'Current EO', 'Black Opium', 'text'),
                        ('e1_days', 'E1 Days', 'E.g. 1,2,3', 'text'), ('e1_start', 'E1 Start', 'HH:MM', 'text'),
                        ('e1_end', 'E1 End', 'HH:MM', 'text'), ('e1_pause', 'E1 Pause', 'secs', 'number'), ('e1_work', 'E1 Work', 'secs', 'number'),
                        ('e2_days', 'E2 Days', '', 'text'), ('e2_start', 'E2 Start', '', 'text'),
                        ('e2_end', 'E2 End', '', 'text'), ('e2_pause', 'E2 Pause', '', 'number'), ('e2_work', 'E2 Work', '', 'number'),
                        ('e3_days', 'E3 Days', '', 'text'), ('e3_start', 'E3 Start', '', 'text'),
                        ('e3_end', 'E3 End', '', 'text'), ('e3_pause', 'E3 Pause', '', 'number'), ('e3_work', 'E3 Work', '', 'number'),
                        ('e4_days', 'E4 Days', '', 'text'), ('e4_start', 'E4 Start', '', 'text'),
                        ('e4_end', 'E4 End', '', 'text'), ('e4_pause', 'E4 Pause', '', 'number'), ('e4_work', 'E4 Work', '', 'number'),
                        ('month', 'Month Created', '1-12', 'text'),
                        ('year', 'Year Created', '2024', 'number')
                    ] %}
                    <div>
                        <label for="filter_dev_{{ name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{ label }}</label>
                        <input type="{{ type | default('text') }}" id="filter_dev_{{ name }}" name="{{ name }}"
                               value="{{ request.args.get(name, '') }}" placeholder="{{ placeholder }}"
                               class="tailwind-input-class">
                    </div>
                    {% endfor %}
                </div>
                <div class="pt-4 flex justify-end">
                    <button type="submit" class="tailwind-button-blue">Filter Devices</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Data Table Section -->
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-0 sm:p-2">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        {% for header in ['Company', 'Tied to Premise', 'S/N', 'Model', 'Color', 'Current EO',
                                           'E1 Days', 'E1 Start', 'E1 End', 'E1 Pause', 'E1 Work',
                                           'E2 Days', 'E2 Start', 'E2 End', 'E2 Pause', 'E2 Work',
                                           'E3 Days', 'E3 Start', 'E3 End', 'E3 Pause', 'E3 Work',
                                           'E4 Days', 'E4 Start', 'E4 End', 'E4 Pause', 'E4 Work',
                                           'Month Created', 'Year Created'] %}
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">{{ header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for device in data %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.company }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.tied_to_premise }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.sn }}</td> {# Assuming sn from original template, might be device['S/N'] #}
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.model }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.color }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.current_eo }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e1_days }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e1_start }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e1_end }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e1_pause }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e1_work }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e2_days }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e2_start }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e2_end }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e2_pause }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e2_work }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e3_days }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e3_start }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e3_end }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e3_pause }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e3_work }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e4_days }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e4_start }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e4_end }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e4_pause }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.e4_work }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.created_at_month }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ device.created_at_year }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="28" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500 dark:text-gray-400">
                            No device data available.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Controls -->
    {% if data and total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-6 flex justify-center">
        <ul class="inline-flex items-center -space-x-px">
            <li><a href="{{ pagination_base_url }}{{ query_params | to_querystring | update_querystring('page', page - 1) }}" class="tailwind-pagination-button rounded-l-lg {% if page == 1 %}tailwind-pagination-disabled{% endif %}">&laquo; Prev</a></li>
            {% for p in range(max(1, page - 2), min(total_pages + 1, page + 3)) %}
            <li><a href="{{ pagination_base_url }}{{ query_params | to_querystring | update_querystring('page', p) }}" class="tailwind-pagination-button {% if p == page %}tailwind-pagination-active{% endif %}">{{p}}</a></li>
            {% endfor %}
            <li><a href="{{ pagination_base_url }}{{ query_params | to_querystring | update_querystring('page', page + 1) }}" class="tailwind-pagination-button rounded-r-lg {% if page == total_pages %}tailwind-pagination-disabled{% endif %}">Next &raquo;</a></li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Common Tailwind classes
    const tailwindInputClass = "appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50";
    const tailwindButtonBlue = "py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900";
    const tailwindPaginationButton = "py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white";
    const tailwindPaginationActive = "text-blue-600 bg-blue-50 border-blue-300 hover:bg-blue-100 hover:text-blue-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white";
    const tailwindPaginationDisabled = "opacity-50 cursor-not-allowed";

    document.addEventListener('DOMContentLoaded', function () {
        // Filter toggle
        const filterToggleButton = document.getElementById('filterToggleButton');
        const filterFormContainer = document.getElementById('filterFormContainer');
        const filterToggleIcon = document.getElementById('filterToggleIcon');

        if (filterToggleButton && filterFormContainer && filterToggleIcon) {
            // Check if any filter parameters are present in the URL to determine initial state
            const urlParams = new URLSearchParams(window.location.search);
            let filterActive = false;
            const filterInputNames = Array.from(filterFormContainer.querySelectorAll('input, select')).map(el => el.name);
            for (const param of urlParams.keys()) {
                if (filterInputNames.includes(param) && urlParams.get(param) !== '') {
                    filterActive = true;
                    break;
                }
            }
            if (filterActive) {
                filterFormContainer.classList.remove('hidden');
                filterToggleIcon.classList.add('rotate-180');
            }

            filterToggleButton.addEventListener('click', () => {
                filterFormContainer.classList.toggle('hidden');
                filterToggleIcon.classList.toggle('rotate-180');
            });
        }

        // Apply common styles
        document.querySelectorAll('#filterFormContainer input, #filterFormContainer select').forEach(el => {
            if (el.type !== 'submit' && el.type !== 'button') {
                el.classList.add(...tailwindInputClass.split(' '));
            }
        });
        document.querySelectorAll('#filterFormContainer button[type="submit"]').forEach(el => {
             el.classList.add(...tailwindButtonBlue.split(' '));
        });
        document.querySelectorAll('nav[aria-label="Page navigation"] ul.pagination a, nav[aria-label="Page navigation"] ul.pagination span').forEach(el => {
            el.classList.remove('page-link');
            if(el.parentNode.classList.contains('disabled')) { el.classList.add(...tailwindPaginationDisabled.split(' '));}
            if(el.parentNode.classList.contains('active')) { el.classList.add(...tailwindPaginationActive.split(' '));}
            el.classList.add(...tailwindPaginationButton.split(' '));
            if (el.innerHTML.includes('&laquo;')) { el.classList.add('rounded-l-lg'); }
            else if (el.innerHTML.includes('&raquo;')) { el.classList.add('rounded-r-lg');}
        });
    });
</script>
{% endblock %}
