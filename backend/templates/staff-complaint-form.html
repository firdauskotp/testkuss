{% extends "base.html" %}

{% block title %}Staff Case Form - Case {{ case_no }}{% endblock %}
{% block page_title %}Update Case #{{ case_no }}{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> {# If any JS still uses Axios #}
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
    <style>
      .signature-pad-container {
        border: 1px solid #e5e7eb; /* Tailwind gray-200 */
        border-radius: 0.375rem; /* Tailwind rounded-md */
        width: 100%;
        height: 200px;
        position: relative;
        touch-action: none;
      }
      .dark .signature-pad-container {
        border-color: #4b5563; /* Tailwind dark:border-gray-600 */
      }
      canvas.signature-pad {
        width: 100%;
        height: 100%;
        border-radius: 0.375rem; /* Tailwind rounded-md */
      }
      /* Basic styling for the image modal trigger */
      #modalImageTrigger {
        cursor: pointer;
        transition: opacity 0.2s ease-in-out;
      }
      #modalImageTrigger:hover {
        opacity: 0.8;
      }
    </style>
{% endblock %}

{% block content %}
<div class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto space-y-8">

        <div class="text-left mb-6">
            <a href="{{ url_for('dashboard') }}"
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                &larr; Back to Dashboard
            </a>
        </div>

        <form method="POST" action="{{ url_for('staff.staff_form', case_no=case_no) }}" enctype="multipart/form-data" class="space-y-8">

            <!-- Case Details Section -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Case Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="case_no_display" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Case Number</label>
                        <input type="text" id="case_no_display" value="{{ case_no }}" readonly class="tailwind-input-class-disabled">
                    </div>
                    <div>
                        <label for="premise_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Premise Name</label>
                        <input type="text" id="premise_name" value="{{ case_data.premise_name | default('') }}" readonly class="tailwind-input-class-disabled">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Device Location</label>
                        <input type="text" id="location" value="{{ case_data.location | default('') }}" readonly class="tailwind-input-class-disabled">
                    </div>
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                        <input type="text" id="model" value="{{ case_data.model | default('') }}" readonly class="tailwind-input-class-disabled">
                    </div>

                    {% if case_data.get('image_id') %}
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Uploaded Device Image</label>
                        <img src="{{ url_for('api_helpers.get_device_image', image_id=case_data.image_id) }}"
                             alt="Device Image" class="mt-1 rounded-md border border-gray-300 dark:border-gray-600" style="max-width: 200px; max-height: 200px;"
                             data-modal-target="imageModal" data-modal-toggle="imageModal" id="modalImageTrigger">
                    </div>
                    {% endif %}

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reported Issues</label>
                        <div class="mt-1 space-y-1 p-3 border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-700/30">
                            {% set issue_list = ["Weak Scent", "No Oil", "No Mist", "Weak Batteries", "Faulty Power Adapter"] %}
                            {% for issue in issue_list %}
                            <div class="flex items-center">
                                <input id="{{ issue|replace(' ', '_')|lower }}_display" type="checkbox"
                                       class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 cursor-not-allowed"
                                       {% if issue in case_data.issues %}checked{% endif %} disabled>
                                <label for="{{ issue|replace(' ', '_')|lower }}_display" class="ml-2 block text-sm text-gray-500 dark:text-gray-400">{{ issue }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label for="remarks-issues" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Client Remarks</label>
                        <textarea id="remarks-issues" rows="3" readonly class="tailwind-input-class-disabled">{{ case_data.remarks | default('') }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Actions Done Section -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Actions Performed by Staff</h3>
                <div class="space-y-3">
                    {% set action_list = [
                      "Alcohol Cleaning", "Oil Refill", "Timer Settings",
                      "Replaced Straw / Mist Head", "Replaced Batteries",
                      "Replaced Faulty Machine (Same Model)", "Changed Machine (Different Model)",
                      "Replaced Faulty Power Adapter"
                    ] %}
                    {% for action in action_list %}
                    <div class="flex items-center">
                        <input id="{{ action|replace(' ', '')|replace('/', '')|lower }}" name="actions" value="{{ action }}" type="checkbox"
                               class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:focus:ring-offset-gray-800"
                               {% if case_data.get("actions_done") and action in case_data["actions_done"] %}checked{% endif %}>
                        <label for="{{ action|replace(' ', '')|replace('/', '')|lower }}" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">{{ action }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Acknowledgement Section -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Acknowledgement & Follow-up</h3>
                <div class="space-y-6">
                    <div>
                        <label for="remarks-acknowledgement" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Staff Remarks</label>
                        <textarea id="remarks-acknowledgement" name="remarks" rows="3" class="tailwind-input-class">{{ case_data.get('remarks', '') }}</textarea> {# Assuming staff remarks might be pre-filled or this is the field for new remarks #}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Case Closed?</label>
                        <div class="flex items-center space-x-6">
                            <div class="flex items-center">
                                <input id="caseClosedYes" name="case_closed" type="radio" value="Yes" class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 focus:ring-indigo-500 dark:focus:ring-offset-gray-800" {% if case_data.get('case_closed') == 'Yes' %}checked{% endif %}>
                                <label for="caseClosedYes" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Yes</label>
                            </div>
                            <div class="flex items-center">
                                <input id="caseClosedNo" name="case_closed" type="radio" value="No" class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 focus:ring-indigo-500 dark:focus:ring-offset-gray-800" {% if case_data.get('case_closed') == 'No' %}checked{% endif %}>
                                <label for="caseClosedNo" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">No, revisit on:</label>
                            </div>
                        </div>
                    </div>

                    <div id="appointmentTable" class="{% if case_data.get('case_closed') != 'No' %}hidden{% endif %} mt-4 p-4 border border-gray-200 dark:border-gray-700 rounded-md space-y-4">
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Select Appointment Date & Time:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="appointment_date" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                                <input type="date" id="appointment_date" name="appointment_date" value="{{ case_data.get('revisit_date', '') }}" class="tailwind-input-class text-sm">
                            </div>
                            <div>
                                <label for="appointment_time" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Time</label>
                                <input type="time" id="appointment_time" name="appointment_time" value="{{ case_data.get('revisit_time', '') }}" class="tailwind-input-class text-sm">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="staffName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Staff Name</label>
                        <input type="text" id="staffName" name="staff_name" value="{{ case_data.get('staff_name', session.get('username', '')) }}" required class="tailwind-input-class">
                    </div>

                    <div>
                        <label for="signature" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Client Signature</label>
                        <div class="signature-pad-container">
                            <canvas id="signature-pad" class="signature-pad"></canvas>
                        </div>
                        <input type="hidden" name="signature" id="signature-input">
                        <button type="button" id="clear-signature"
                                class="mt-2 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                            Clear Signature
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button type="submit"
                        class="py-2.5 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white
                               bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600
                               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-900">
                    Update Case
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
    <div class="relative p-4 w-full max-w-2xl h-full md:h-auto mx-auto flex items-center">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full">
            <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700 rounded-t">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    Device Image
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="imageModal">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="p-6 text-center">
                <img id="modalImage" src="" class="max-w-full h-auto max-h-[70vh] mx-auto rounded-md">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Common Tailwind classes for inputs (used if JS needs to create similar elements or as a reference)
    const tailwindInputClass = "appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50";
    const tailwindInputClassDisabled = "appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed";

    document.addEventListener('DOMContentLoaded', function() {
        // Apply disabled styles to elements with the class
        document.querySelectorAll('.tailwind-input-class-disabled').forEach(el => {
            el.classList.add(...tailwindInputClassDisabled.split(' '));
            // Ensure base input classes are also there if not already part of the macro/direct class
            tailwindInputClass.split(' ').forEach(cls => {
                if (!el.classList.contains(cls)) el.classList.add(cls);
            });
        });
        // Apply general input styles to other inputs/selects/textareas if not already applied
         document.querySelectorAll('form select, form input[type="text"], form input[type="date"], form input[type="time"], form input[type="number"], form textarea').forEach(el => {
            if (!el.classList.contains('tailwind-input-class') && !el.classList.contains('tailwind-input-class-disabled') && !el.id.includes('signature')) {
                el.classList.add(...tailwindInputClass.split(' '));
                 if (el.disabled || el.readOnly) {
                    el.classList.add(...tailwindInputClassDisabled.split(' ').filter(c => !c.startsWith('appearance-none'))); // Avoid double appearance-none
                }
            }
        });


        const modalImageTrigger = document.getElementById("modalImageTrigger");
        const imageModal = document.getElementById("imageModal");
        const modalImage = document.getElementById("modalImage");

        if (modalImageTrigger && imageModal && modalImage) {
            modalImageTrigger.addEventListener("click", function() {
                modalImage.src = this.src;
                imageModal.classList.remove('hidden');
                imageModal.classList.add('flex'); // For centering
            });
        }

        // Generic modal hide logic
        document.querySelectorAll('[data-modal-hide]').forEach(function (hideBtn) {
            const modalId = hideBtn.getAttribute('data-modal-hide');
            const modal = document.getElementById(modalId);
            if (modal) {
                hideBtn.addEventListener('click', function () {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                });
            }
        });


        // Show/hide appointment table
        const caseClosedYes = document.getElementById("caseClosedYes");
        const caseClosedNo = document.getElementById("caseClosedNo");
        const appointmentTable = document.getElementById("appointmentTable");

        function toggleAppointmentTable() {
            if (caseClosedNo && caseClosedNo.checked) {
                appointmentTable.classList.remove("hidden");
            } else {
                appointmentTable.classList.add("hidden");
            }
        }
        if(caseClosedYes) caseClosedYes.addEventListener("change", toggleAppointmentTable);
        if(caseClosedNo) caseClosedNo.addEventListener("change", toggleAppointmentTable);
        // Initial check
        // toggleAppointmentTable(); // Handled by Jinja condition now


        // Signature Pad
        const canvas = document.getElementById("signature-pad");
        const signaturePad = new SignaturePad(canvas, {
            minWidth: 1,
            maxWidth: 2.5,
            penColor: document.documentElement.getAttribute('data-theme') === 'dark' ? "white" : "black"
        });
        const savedSignature = "{{ case_data.get('signature', '')|escapejs }}"; // Use escapejs for safety

        if (savedSignature && savedSignature.startsWith("data:image")) {
            // Delay loading to ensure canvas is sized if it depends on CSS fully loading
            setTimeout(() => {
                if(canvas.offsetWidth > 0 && canvas.offsetHeight > 0) { // Check if canvas is visible and sized
                    const img = new Image();
                    img.onload = () => {
                        const ctx = canvas.getContext("2d");
                        // Ensure canvas is clear before drawing, respecting current transform
                        const currentTransform = ctx.getTransform();
                        ctx.setTransform(1,0,0,1,0,0); // Reset transform for clear
                        ctx.clearRect(0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1));
                        ctx.setTransform(currentTransform); // Restore original transform

                        // Scale image draw to fit canvas if needed, or draw at 1:1
                        // For simplicity, draw directly. May need adjustments if image is larger than canvas.
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = savedSignature;
                } else {
                     // Fallback or retry if canvas not sized
                    console.warn("Signature canvas not ready for drawing saved signature.");
                }
            }, 200); // Small delay
        }

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            if (canvas.offsetWidth > 0 && canvas.offsetHeight > 0) {
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
                 // Redraw saved signature if it exists after resize
                if (savedSignature && savedSignature.startsWith("data:image") && !signaturePad.isEmpty()) {
                     // This part is tricky as signaturePad.fromDataURL would overwrite,
                     // we need to re-apply the original image data if it was there.
                     // For simplicity, if user hasn't drawn, and there's saved data, try to reload.
                     // This might need more robust handling if user draws then resizes.
                    const tempImg = new Image();
                    tempImg.onload = () => { canvas.getContext("2d").drawImage(tempImg,0,0); };
                    tempImg.src = savedSignature;
                }
            }
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas(); // Initial call

        document.getElementById("clear-signature").addEventListener("click", function() {
            signaturePad.clear();
        });

        document.querySelector("form").addEventListener("submit", function(event) {
            if (!signaturePad.isEmpty()) {
                document.getElementById("signature-input").value = signaturePad.toDataURL("image/png");
            }
        });

        // Theme change listener for signature pad color
        if (window.matchMedia) {
          const mediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');
          mediaQueryList.addEventListener('change', event => {
            signaturePad.penColor = event.matches ? "white" : "black";
            signaturePad.clear(); // Or try to redraw with new color if content exists
          });
        }
        // Also check on theme toggle button click (if theme-toggle.js doesn't handle this)
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        if (themeToggleButton) {
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        signaturePad.penColor = document.documentElement.getAttribute('data-theme') === 'dark' ? "white" : "black";
                        signaturePad.clear(); // Or redraw
                    }
                });
            });
            observer.observe(document.documentElement, { attributes: true });
        }


        // The fetch logic for case data based on case_no input seems to be for a different form or workflow,
        // as this page receives case_data directly from Flask. So, that specific JS part is omitted here.
    });
</script>
{% endblock %}
