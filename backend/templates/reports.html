{% extends "base.html" %}

{% block title %}All Data Reports{% endblock %}
{% block page_title %}Comprehensive Data Report{% endblock %}

{% block head_extra %}
    {# Any page-specific CSS or JS links for this page #}
{% endblock %}

{% block content %}
<div class="py-8 px-4 sm:px-6 lg:px-8 space-y-8">

    <div class="flex justify-start mb-6">
        <a href="{{ url_for('dashboard') }}"
           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
            &larr; Back to Dashboard
        </a>
    </div>

    <!-- Filter Form Section -->
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
        <button id="filterToggleButton"
                class="w-full flex justify-between items-center py-3 px-4 text-left text-lg font-semibold text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700/50 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <span>Show/Hide Filters</span>
            <svg id="filterToggleIcon" class="w-5 h-5 transform transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
        <div id="filterFormContainer" class="hidden mt-6">
            <form method="get" action="{{ url_for('data_reports.reports') }}" class="space-y-6"> {# Assuming 'reports' is the correct endpoint for filtering #}
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4">
                    {# Helper macro for form fields could be useful here if Jinja2 supports it easily in this context #}
                    {% for name, label, placeholder, type in [
                        ('month', 'Month (Fill in year too)', '10', 'text'),
                        ('year', 'Year (Fill in month too)', '2024', 'number'),
                        ('Company', 'Company Name', 'Valencia', 'text'),
                        ('industry', 'Industry', 'Industry', 'text'),
                        ('premise', 'Premise Name', 'Premise Name', 'text'),
                        ('pic', 'PIC Name', 'Person In Charge', 'text'),
                        ('Model', 'Model', 'VOX', 'text'),
                        ('Colour', 'Colour (First Letter)', 'R', 'text'),
                        ('EO', 'EO', 'Black Opium', 'text'),
                        ('Volume', 'Volume', '10', 'number'),
                        ('SN', 'S/N', '12345', 'number'),
                        ('Balance', 'Balance', '10', 'number'),
                        ('Consumption', 'Consumption', '10', 'number'),
                        ('Refilled', 'Refilled', '10', 'number'),
                        ('E1_Days', 'E1-Days', '1,2,3,4,5', 'text'),
                        ('E1_Start', 'E1-Start', '09:00:00', 'text'),
                        ('E1_End', 'E1-End', '12:00:00', 'text'),
                        ('E1_Work', 'E1-Work', '100', 'number'),
                        ('E1_Pause', 'E1-Pause', '120', 'number'),
                        ('E2_Days', 'E2-Days', '1,2,3,4,5', 'text'),
                        ('E2_Start', 'E2-Start', '09:00:00', 'text'),
                        ('E2_End', 'E2-End', '12:00:00', 'text'),
                        ('E2_Work', 'E2-Work', '100', 'number'),
                        ('E2_Pause', 'E2-Pause', '120', 'number'),
                        ('E3_Days', 'E3-Days', '1,2,3,4,5', 'text'),
                        ('E3_Start', 'E3-Start', '09:00:00', 'text'),
                        ('E3_End', 'E3-End', '12:00:00', 'text'),
                        ('E3_Work', 'E3-Work', '100', 'number'),
                        ('E3_Pause', 'E3-Pause', '200', 'number'),
                        ('E4_Days', 'E4-Days', '1,2,3,4,5', 'text'),
                        ('E4_Start', 'E4-Start', '09:00:00', 'text'),
                        ('E4_End', 'E4-End', '12:00:00', 'text'),
                        ('E4_Work', 'E4-Work', '100', 'number'),
                        ('E4_Pause', 'E4-Pause', '120', 'number'),
                        ('Other_Remarks', 'Other Remarks', 'Other Remarks', 'text')
                    ] %}
                    <div>
                        <label for="{{ name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{ label }}</label>
                        <input type="{{ type | default('text') }}" id="{{ name }}" name="{{ name }}"
                               value="{{ request.args.get(name, '') }}"
                               placeholder="{{ placeholder }}"
                               class="tailwind-input-class">
                    </div>
                    {% endfor %}
                </div>
                <div class="pt-4 flex justify-end">
                    <button type="submit"
                            class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900">
                        Filter Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Data Table Section -->
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-0 sm:p-2">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        {% for header in ['Company', 'Industry', 'Premise Name', 'Premise Area', 'Premise Address', 'PICs', 'Model', 'Colour', 'S/N', 'Volume', 'Current EO', 'Balance', 'Consumption', 'New EO', 'Refilled', 'E1-Days', 'E1-Start', 'E1-End', 'E1-Work', 'E1-Pause', 'E2-Days', 'E2-Start', 'E2-End', 'E2-Work', 'E2-Pause', 'E3-Days', 'E3-Start', 'E3-End', 'E3-Work', 'E3-Pause', 'E4-Days', 'E4-Start', 'E4-End', 'E4-Work', 'E4-Pause', 'Scent Effectiveness', 'Common Encounters', 'Other Remarks', 'Month', 'Year'] %}
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider whitespace-nowrap">{{ header }}</th>
                        {% endfor %}
                        {# <th scope="col" class="relative px-4 py-3"><span class="sr-only">Edit</span></th> #}
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for item_row in data %} {# Renamed loop variable from 'user' to 'item_row' for clarity #}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50"
                        data-id="{{ item_row['_id'] }}"
                        data-company="{{ item_row['company'] }}"
                        data-premise-name="{{ item_row['Premise Name'] }}"
                        data-model="{{ item_row['Model'] }}"
                        data-color="{{ item_row['Color'] }}"
                        data-sn="{{ item_row['S/N'] }}"
                        data-volume="{{ item_row['Volume'] }}"
                        data-current-eo="{{ item_row['Current EO'] }}"
                        data-balance="{{ item_row['Balance'] }}"
                        data-consumption="{{ item_row['Consumption'] }}"
                        data-new-eo="{{ item_row['New EO'] }}"
                        data-refilled="{{ item_row['Refilled'] }}"
                        data-e1-days="{{ item_row['E1 - DAYS'] }}" data-e1-start="{{ item_row['E1 - START'] }}" data-e1-end="{{ item_row['E1 - END'] }}" data-e1-work="{{ item_row['E1 - WORK'] }}" data-e1-pause="{{ item_row['E1 - PAUSE'] }}"
                        data-e2-days="{{ item_row['E2 - DAYS'] }}" data-e2-start="{{ item_row['E2 - START'] }}" data-e2-end="{{ item_row['E2 - END'] }}" data-e2-work="{{ item_row['E2 - WORK'] }}" data-e2-pause="{{ item_row['E2 - PAUSE'] }}"
                        data-e3-days="{{ item_row['E3 - DAYS'] }}" data-e3-start="{{ item_row['E3 - START'] }}" data-e3-end="{{ item_row['E3 - END'] }}" data-e3-work="{{ item_row['E3 - WORK'] }}" data-e3-pause="{{ item_row['E3 - PAUSE'] }}"
                        data-e4-days="{{ item_row['E4 - DAYS'] }}" data-e4-start="{{ item_row['E4 - START'] }}" data-e4-end="{{ item_row['E4 - END'] }}" data-e4-work="{{ item_row['E4 - WORK'] }}" data-e4-pause="{{ item_row['E4 - PAUSE'] }}"
                        data-scent-effectiveness="{{ item_row['#1 Scent Effectiveness'] }}"
                        data-common-encounters="{{ item_row['#1 Common encounters'] }}"
                        data-other-remarks="{{ item_row['#1 Other remarks'] }}"
                        data-month="{{ item_row['month'] }}"
                        data-year="{{ item_row['year'] }}"
                        data-month-year="{{ item_row.get('month_year') if item_row.get('month_year') is string else item_row.get('month_year').isoformat() if item_row.get('month_year') else '' }}"
                    >
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['company'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row.industry }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Premise Name'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row.premise_area }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row.premise_address }}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">
                            {% if item_row.pics %}
                                <ul class="list-disc list-inside space-y-1">
                                {% for pic in item_row.pics %}
                                    <li><strong>{{ pic.name }}</strong> ({{ pic.designation }})<br/>C: {{ pic.contact }}<br/>E: {{ pic.email }}</li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                No PIC
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Model'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Color'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['S/N'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Volume'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Current EO'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Balance'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Consumption'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['New EO'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['Refilled'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E1 - DAYS'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E1 - START'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E1 - END'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E1 - WORK'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E1 - PAUSE'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E2 - DAYS'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E2 - START'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E2 - END'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E2 - WORK'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E2 - PAUSE'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E3 - DAYS'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E3 - START'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E3 - END'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E3 - WORK'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E3 - PAUSE'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E4 - DAYS'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E4 - START'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E4 - END'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E4 - WORK'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['E4 - PAUSE'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['#1 Scent Effectiveness'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['#1 Common encounters'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['#1 Other remarks'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['month'] }}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{{ item_row['year'] }}</td>
                        {# <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button type="button" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 edit-btn"
                                    data-modal-target="editModal" data-modal-toggle="editModal">Edit</button>
                        </td> #}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="40" class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500 dark:text-gray-400">
                            No data available for the current filters.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Controls -->
    {% if data %}
    {% include 'partials/pagination.html' %}
    {% endif %}
</div>

<!-- Edit Modal -->
<div id="editModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
    <div class="relative p-4 w-full max-w-2xl h-full md:h-auto mx-auto flex items-center">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full">
            <div class="flex justify-between items-center p-5 border-b border-gray-300 dark:border-gray-700 rounded-t">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Edit Record</h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="editModal">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <form id="editForm" class="p-6 space-y-4">
                <input type="hidden" id="editRecordId" name="sn"> {# Changed from recordId to editRecordId, added name="sn" #}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editCompany" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company</label>
                        <input type="text" id="editCompany" name="company" class="tailwind-input-class">
                    </div>
                    <div>
                        <label for="editPremiseName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Premise Name</label>
                        <input type="text" id="editPremiseName" name="premise_name" class="tailwind-input-class">
                    </div>
                    {# Add other static fields like Model, Color, SN, Volume, Current EO, Balance, Consumption, New EO, Refilled, Scent Effect, Common Enc, Other Remarks #}
                    {# For brevity, only a few E-fields are shown below. All should be included. #}
                </div>
                <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200 pt-2 border-t border-gray-200 dark:border-gray-700 mt-4">Event Settings</h4>
                {% for i in range(1, 5) %}
                <details class="bg-gray-50 dark:bg-gray-700/30 p-3 rounded-md">
                    <summary class="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer">Event {{i}}</summary>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2">
                        <div>
                            <label for="editE{{i}}Days" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">E{{i}}-Days</label>
                            <input type="text" id="editE{{i}}Days" name="E{{i}} - DAYS" class="tailwind-input-class text-xs">
                        </div>
                        <div>
                            <label for="editE{{i}}Start" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">E{{i}}-Start</label>
                            <input type="text" id="editE{{i}}Start" name="E{{i}} - START" class="tailwind-input-class text-xs">
                        </div>
                        <div>
                            <label for="editE{{i}}End" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">E{{i}}-End</label>
                            <input type="text" id="editE{{i}}End" name="E{{i}} - END" class="tailwind-input-class text-xs">
                        </div>
                        <div>
                            <label for="editE{{i}}Work" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">E{{i}}-Work</label>
                            <input type="number" id="editE{{i}}Work" name="E{{i}} - WORK" class="tailwind-input-class text-xs">
                        </div>
                        <div>
                            <label for="editE{{i}}Pause" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">E{{i}}-Pause</label>
                            <input type="number" id="editE{{i}}Pause" name="E{{i}} - PAUSE" class="tailwind-input-class text-xs">
                        </div>
                    </div>
                </details>
                {% endfor %}
                 <div>
                    <label for="editMonthYear" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Month-Year (Date)</label>
                    <input type="date" id="editMonthYear" name="month_year" class="tailwind-input-class">
                </div>

                <div class="flex items-center justify-end p-4 border-t border-gray-300 dark:border-gray-700 rounded-b space-x-2">
                    <button data-modal-hide="editModal" type="button" class="py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">Cancel</button>
                    <button type="submit" class="py-2 px-4 text-sm font-medium text-white bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500 dark:focus:ring-offset-gray-900">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Common Tailwind input class definition for JS
    const tailwindInputClass = "appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50";
    // Apply to filter form inputs that might not have it (if any added dynamically, though not in this form)
    document.querySelectorAll('#filterFormContainer input, #filterFormContainer select').forEach(el => {
        if (!el.classList.contains('tailwind-input-class')) { // Basic check
            el.classList.add(...tailwindInputClass.split(' '));
        }
    });


    // Accordion toggle for filter form
    const filterToggleButton = document.getElementById('filterToggleButton');
    const filterFormContainer = document.getElementById('filterFormContainer');
    const filterToggleIcon = document.getElementById('filterToggleIcon');

    if (filterToggleButton && filterFormContainer && filterToggleIcon) {
        filterToggleButton.addEventListener('click', () => {
            filterFormContainer.classList.toggle('hidden');
            filterToggleIcon.classList.toggle('rotate-180');
        });
    }

    // Modal interactions (basic show/hide)
    document.querySelectorAll('[data-modal-toggle]').forEach(function (toggleBtn) {
        const modalId = toggleBtn.getAttribute('data-modal-target');
        const modal = document.getElementById(modalId);
        if (modal) {
            toggleBtn.addEventListener('click', function () {
                modal.classList.remove('hidden');
                modal.classList.add('flex'); // Use flex for centering
                // Populate modal - specific to editModal
                if (modalId === 'editModal') {
                    const row = toggleBtn.closest('tr'); // Assuming button is in a table row
                    if (row) {
                        document.getElementById('editRecordId').value = row.dataset.sn; // Use S/N as ID
                        document.getElementById('editCompany').value = row.dataset.company || '';
                        document.getElementById('editPremiseName').value = row.dataset.premiseName || '';

                        for(let i = 1; i <= 4; i++) {
                            document.getElementById(`editE\${i}Days`).value = row.dataset[`e\${i}Days`] || '';
                            document.getElementById(`editE\${i}Start`).value = row.dataset[`e\${i}Start`] || '';
                            document.getElementById(`editE\${i}End`).value = row.dataset[`e\${i}End`] || '';
                            document.getElementById(`editE\${i}Work`).value = row.dataset[`e\${i}Work`] || '';
                            document.getElementById(`editE\${i}Pause`).value = row.dataset[`e\${i}Pause`] || '';
                        }
                        // Convert YYYY-MM-DDTHH:MM:SS to YYYY-MM-DD for date input
                        const monthYearFull = row.dataset.monthYear;
                        if (monthYearFull) {
                            document.getElementById('editMonthYear').value = monthYearFull.split('T')[0];
                        } else {
                            document.getElementById('editMonthYear').value = '';
                        }
                    }
                }
            });
        }
    });

    document.querySelectorAll('[data-modal-hide]').forEach(function (hideBtn) {
        const modalId = hideBtn.getAttribute('data-modal-hide');
        const modal = document.getElementById(modalId);
        if (modal) {
            hideBtn.addEventListener('click', function () {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
        }
    });

    // Edit form submission
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(editForm);
            const data = Object.fromEntries(formData.entries());

            // The endpoint in original JS was /update-record, using S/N as 'id'
            // The hidden input for ID is now named 'sn' matching original form data
            // The flask endpoint expects 'S/N' in caps, but form names are usually lowercase/snake_case
            // Adjusting to send 'S/N' as the key for the ID.
            const recordId = data.sn; // This is from <input type="hidden" id="editRecordId" name="sn">
            delete data.sn; // remove it from main payload if it's just an identifier
            const payload = { 'S/N': recordId, ...data };


            fetch("{{ url_for('api_helpers.update_data') }}", { // Assuming 'update_data' is the correct Flask endpoint
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Record updated successfully!');
                    location.reload();
                } else {
                    alert('Error updating record: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Error submitting edit form:', err);
                alert('An error occurred while submitting the form.');
            });
        });
    }
</script>
{% endblock %}
