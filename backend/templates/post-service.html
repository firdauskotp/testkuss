{% extends "base.html" %}

{% block title %}Post-Service Report{% endblock %}
{% block page_title %}Post-Service Report{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock %}

{% block content %}
<div class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto space-y-8">

        <div class="text-left mb-6">
            <a href="{{ url_for('dashboard') }}"
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                &larr; Back to Dashboard
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="space-y-3">
                {% for category, message in messages %}
                <div class="p-4 text-sm rounded-md border
                            {% if category == 'danger' %} bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 border-red-300 dark:border-red-500/50 {% endif %}
                            {% if category == 'success' %} bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-300 dark:border-green-500/50 {% endif %}
                            " role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
            <form id="post-service-form" action="{{ url_for('forms.post_service') }}" method="POST" class="space-y-6">
                <div>
                    <label for="essential_oil" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Essential Oil</label>
                    <select id="essential_oil" name="essential_oil" required
                            class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600
                                   rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500
                                   focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500
                                   sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        <option value="" selected disabled>Loading EOs...</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="oil_balance" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Oil Balance (ml)</label>
                        <input type="number" id="oil_balance" name="oil_balance" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600
                                      rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500
                                      focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500
                                      sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                    </div>
                    <div>
                        <label for="balance_brought_back" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Balance Brought Back (ml)</label>
                        <input type="number" id="balance_brought_back" name="balance_brought_back" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600
                                      rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500
                                      focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500
                                      sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                    </div>
                    <div>
                        <label for="balance_brought_back_percent" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Balance Brought Back (%)</label>
                        <input type="text" id="balance_brought_back_percent" name="balance_brought_back_percent" readonly
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600
                                      rounded-md shadow-sm sm:text-sm bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed">
                    </div>
                    <div>
                        <label for="refill_amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Refill Amount (ml)</label>
                        <input type="number" id="refill_amount" name="refill_amount" readonly
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600
                                      rounded-md shadow-sm sm:text-sm bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed">
                    </div>
                    <div class="md:col-span-2">
                        <label for="refill_amount_percent" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Refill Amount (%)</label>
                        <input type="text" id="refill_amount_percent" name="refill_amount_percent" readonly
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600
                                      rounded-md shadow-sm sm:text-sm bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed">
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit"
                            class="w-full flex justify-center py-2.5 px-4 border border-transparent
                                   rounded-md shadow-sm text-sm font-medium text-white
                                   bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600
                                   focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-900">
                        Submit Post-Service Data
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Common Tailwind input class for JS (if needed, but mostly applied in HTML)
    const tailwindInputClass = "appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50";

    document.addEventListener('DOMContentLoaded', function() {
        // Populate essential oil dropdown
        const essentialOilSelect = document.getElementById("essential_oil");
        if (essentialOilSelect) {
            axios.get("{{ url_for('api_helpers.get_essential_oils') }}") // Using Flask's url_for
                .then(response => {
                    const essentialOils = response.data;
                    essentialOilSelect.innerHTML = '<option value="" selected disabled>Select an Essential Oil</option>'; // Clear loading/default
                    if (Array.isArray(essentialOils)) {
                        essentialOils.forEach(eo => {
                            essentialOilSelect.innerHTML += `<option value="${eo}">${eo}</option>`;
                        });
                    }
                })
                .catch(error => {
                    console.error("Error fetching essential oils:", error);
                    essentialOilSelect.innerHTML = '<option value="" selected disabled>Error loading EOs</option>';
                });
        }

        // Realtime percentage calculation
        const postServiceForm = document.getElementById("post-service-form");
        if (postServiceForm) {
            postServiceForm.addEventListener("input", function() {
                const oilBalanceInput = document.getElementById("oil_balance");
                const balanceBroughtBackInput = document.getElementById("balance_brought_back");
                const refillAmountInput = document.getElementById("refill_amount");
                const balanceBroughtBackPercentInput = document.getElementById("balance_brought_back_percent");
                const refillAmountPercentInput = document.getElementById("refill_amount_percent");

                const oilBalance = parseFloat(oilBalanceInput.value) || 0;
                const balanceBroughtBack = parseFloat(balanceBroughtBackInput.value) || 0;

                let refillAmount = 0;
                // Ensure balance brought back is not more than original oil balance
                let actualBalanceBroughtBack = balanceBroughtBack;
                if (balanceBroughtBack > oilBalance) {
                    actualBalanceBroughtBack = oilBalance;
                    if (balanceBroughtBackInput) balanceBroughtBackInput.value = oilBalance.toFixed(2); // Correct user input
                }

                refillAmount = oilBalance - actualBalanceBroughtBack;

                if (refillAmountInput) refillAmountInput.value = refillAmount.toFixed(2);

                const balancePercent = oilBalance ? (actualBalanceBroughtBack / oilBalance) * 100 : 0;
                const refillPercent = oilBalance ? (refillAmount / oilBalance) * 100 : 0;

                if (balanceBroughtBackPercentInput) balanceBroughtBackPercentInput.value = `${balancePercent.toFixed(2)}%`;
                if (refillAmountPercentInput) refillAmountPercentInput.value = `${refillPercent.toFixed(2)}%`;
            });
        }

        // Apply Tailwind classes to all relevant form elements (fallback if not directly in HTML)
        // This ensures dynamically loaded selects also get styled if they don't have the class.
        document.querySelectorAll('#post-service-form select, #post-service-form input[type="number"], #post-service-form input[type="text"]').forEach(el => {
            // Check if element already has styling from being an `appearance-none` or our common class
            let needsClass = true;
            for(let cl of el.classList) {
                if(cl === 'appearance-none' || cl === 'tailwind-input-class') { // if it has either, it's likely styled
                    needsClass = false;
                    break;
                }
            }
            // Add the base class if it's missing
            if(needsClass) {
                 // Ensure not to double-add 'appearance-none' if it's part of tailwindInputClass definition
                 if (!el.classList.contains('appearance-none') && tailwindInputClass.includes('appearance-none')) {
                    el.classList.add('appearance-none');
                 }
                 // Add other classes from tailwindInputClass
                 tailwindInputClass.split(' ').forEach(cls => {
                    if (cls !== 'appearance-none' && !el.classList.contains(cls)) {
                        el.classList.add(cls);
                    }
                 });
            }

            if (el.readOnly || el.disabled) { // Ensure readonly/disabled also get styled correctly
                el.classList.add('bg-gray-100', 'dark:bg-gray-700', 'cursor-not-allowed', 'text-gray-500', 'dark:text-gray-400');
            }
        });
    });
</script>
{% endblock %}
