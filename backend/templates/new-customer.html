{% extends "base.html" %}

{% block title %}New Customer Form{% endblock %}
{% block page_title %}New Customer Registration{% endblock %}

{% block head_extra %}
    {# Add any page-specific CSS links or head content here if needed in the future #}
{% endblock %}

{% block content %}
<div class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto space-y-8">

        <div class="text-left mb-6">
            <a href="{{ url_for('dashboard') }}"
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                &larr; Back to Dashboard
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="space-y-3">
                {% for category, message in messages %}
                <div class="p-4 text-sm rounded-md border
                            {% if category == 'danger' %} bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 border-red-300 dark:border-red-500/50 {% endif %}
                            {% if category == 'success' %} bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-300 dark:border-green-500/50 {% endif %}
                            " role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

        <form id="customerForm" action="{{ url_for('new_customer') }}" method="POST" class="space-y-8">
            <!-- Company Details -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Company Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="companyName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company Name</label>
                        <input type="text" id="companyName" name="companyName"
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50"
                               placeholder="Enter company name" required>
                    </div>
                    <div>
                        <label for="dateCreated" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date Created</label>
                        <input type="date" id="dateCreated" name="dateCreated"
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50"
                               disabled required>
                    </div>
                    <div>
                        <label for="industry" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Industry</label>
                        <input type="text" id="industry" name="industry"
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50"
                               placeholder="Enter industry type" required>
                    </div>
                </div>
            </div>

            <!-- Premise Details -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Premise Details</h3>
                <div id="premiseContainer" class="space-y-6">
                    <!-- Premise Fields Initial -->
                    <div class="premise-item border border-gray-300 dark:border-gray-700 rounded-md p-4 space-y-4" id="premise-1">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">Premise 1 - Name</label>
                        <input type="text" name="premiseName1" id="premiseName1" placeholder="Enter premise name" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        <input type="text" name="premiseArea1" id="premiseArea1" placeholder="Enter premise area" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        <input type="text" name="premiseAddress1" id="premiseAddress1" placeholder="Enter premise address" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        {# Remove button will be added by JS if count > 1 #}
                    </div>
                </div>
                <button type="button" id="addPremiseBtn"
                        class="mt-4 w-full flex justify-center py-2 px-4 border border-dashed border-gray-400 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700/50 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                    + Add New Premise
                </button>
            </div>

            <!-- Contact Details -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Contact Details (PIC)</h3>
                <div id="contactContainer" class="space-y-6">
                    <div class="contact-item border border-gray-300 dark:border-gray-700 rounded-md p-4 space-y-4" id="contact-1">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">PIC 1 - Name</label>
                        <input type="text" name="picName1" id="picName1" placeholder="Enter name" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        <input type="text" name="picDesignation1" id="picDesignation1" placeholder="Enter designation" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        <input type="text" name="picContact1" id="picContact1" placeholder="Enter contact number" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        <input type="email" name="picEmail1" id="picEmail1" placeholder="Enter email" required
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                        <label for="contactPremise1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tie contact to:</label>
                        <select name="contactPremise1" id="contactPremise1" required
                                class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                            <option value="" selected disabled>Select a premise</option>
                            <option value="Premise 1">Premise 1</option> {# Will be updated by JS #}
                            <option value="all">All Premises</option>
                        </select>
                         {# Removed 'tieAllPremises' checkbox, assuming direct selection of 'All Premises' in dropdown #}
                    </div>
                </div>
                <button type="button" id="addContactBtn"
                        class="mt-4 w-full flex justify-center py-2 px-4 border border-dashed border-gray-400 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700/50 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                    + Add New Contact
                </button>
            </div>

            <!-- Device Details -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Device Details</h3>
                <div id="deviceContainer" class="space-y-6">
                    <div class="device-item border border-gray-300 dark:border-gray-700 rounded-md p-4 space-y-4" id="device-1">
                        <h4 class="text-lg font-medium text-gray-800 dark:text-gray-200">Device 1</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label for="deviceLocation1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location</label>
                                <input type="text" name="deviceLocation1" id="deviceLocation1" placeholder="Enter location" required class="tailwind-input-class">
                            </div>
                            <div>
                                <label for="deviceSN1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">S/N</label>
                                <input type="number" name="deviceSN1" id="deviceSN1" placeholder="Enter serial number" required class="tailwind-input-class">
                            </div>
                            <div>
                                <label for="deviceModel1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                                <select name="deviceModel1" id="deviceModel1" required class="tailwind-input-class">
                                    <option value="" selected disabled>Select a model</option>
                                    {% for model in models %}<option value="{{ model.model1 }}">{{ model.model1 }}</option>{% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="deviceColour1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Colour</label>
                                <input type="text" name="deviceColour1" id="deviceColour1" placeholder="Enter colour" required class="tailwind-input-class">
                            </div>
                            <div>
                                <label for="deviceVolume1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Volume Required</label>
                                <input type="number" name="deviceVolume1" id="deviceVolume1" placeholder="Enter volume required" required class="tailwind-input-class">
                            </div>
                            <div>
                                <label for="deviceScent1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Scent</label>
                                <select name="deviceScent1" id="deviceScent1" required class="tailwind-input-class">
                                    <option value="" selected disabled>Select a scent</option>
                                    {% for eo in essential_oils %}<option value="{{ eo.eo_name }}">{{ eo.eo_name }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="devicePremise1" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tie Device to Premise:</label>
                                <select name="devicePremise1" id="devicePremise1" required class="tailwind-input-class">
                                    <option value="" selected disabled>Select a premise</option>
                                    <option value="Premise 1">Premise 1</option> {# Will be updated by JS #}
                                </select>
                            </div>
                        </div>
                        <!-- Events for Device -->
                        {% for i in range(1, 5) %}
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h5 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-2">Event {{i}}</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                                <div>
                                    <label for="E{{i}}Days1" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Days</label>
                                    <input type="text" name="E{{i}}Days1" id="E{{i}}Days1" placeholder="e.g., Mon-Fri" {% if i==1 %}required{% endif %} class="tailwind-input-class text-xs">
                                </div>
                                <div>
                                    <label for="E{{i}}StartTime1" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Start Time</label>
                                    <input type="text" name="E{{i}}StartTime1" id="E{{i}}StartTime1" placeholder="HH:MM" {% if i==1 %}required{% endif %} class="tailwind-input-class text-xs">
                                </div>
                                <div>
                                    <label for="E{{i}}EndTime1" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">End Time</label>
                                    <input type="text" name="E{{i}}EndTime1" id="E{{i}}EndTime1" placeholder="HH:MM" {% if i==1 %}required{% endif %} class="tailwind-input-class text-xs">
                                </div>
                                <div>
                                    <label for="E{{i}}Work1" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Work (s)</label>
                                    <input type="number" name="E{{i}}Work1" id="E{{i}}Work1" placeholder="e.g., 60" {% if i==1 %}required{% endif %} class="tailwind-input-class text-xs">
                                </div>
                                <div>
                                    <label for="E{{i}}Pause1" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Pause (s)</label>
                                    <input type="number" name="E{{i}}Pause1" id="E{{i}}Pause1" placeholder="e.g., 120" {% if i==1 %}required{% endif %} class="tailwind-input-class text-xs">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <button type="button" id="addDeviceBtn"
                        class="mt-4 w-full flex justify-center py-2 px-4 border border-dashed border-gray-400 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700/50 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                    + Add New Device
                </button>
            </div>

            <div class="mt-8 flex justify-end">
                <button type="submit"
                        class="py-2.5 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-900">
                    Submit Form
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const tailwindInputClass = "appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50";
    const tailwindInputClassXs = tailwindInputClass + " text-xs"; // For smaller event inputs
    const tailwindRemoveBtnClass = "mt-2 py-1 px-3 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500 dark:focus:ring-offset-gray-900";

    let premiseCount = 1;
    let contactCount = 1;
    let deviceCount = 1;

    const modelData = JSON.parse(document.getElementById("modelListData").textContent || "[]");
    const modelOptions = modelData.map(m => `<option value="${m.model1}">${m.model1}</option>`).join("");
    const eoData = JSON.parse(document.getElementById("eoListData").textContent || "[]");
    const eoOptions = eoData.map(e => `<option value="${e.eo_name}">${e.eo_name}</option>`).join("");

    function getPremiseOptionsHTML() {
        const premiseItems = document.querySelectorAll('.premise-item');
        let options = '<option value="" selected disabled>Select a premise</option>';
        premiseItems.forEach((item, index) => {
            const nameInput = item.querySelector('input[name^="premiseName"]');
            const premiseName = nameInput.value || `Premise ${index + 1}`;
            options += `<option value="${premiseName}">${premiseName}</option>`;
        });
        options += '<option value="all">All Premises</option>';
        return options;
    }

    function updatePremiseDropdowns() {
        const optionsHTML = getPremiseOptionsHTML();
        document.querySelectorAll('select[name^="contactPremise"], select[name^="devicePremise"]').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = optionsHTML;
            // Try to restore previous selection if still valid
            if (Array.from(select.options).some(opt => opt.value === currentValue)) {
                 select.value = currentValue;
            } else {
                 select.value = ""; // Reset if previous premise name changed or removed
            }
        });
    }

    document.getElementById('premiseContainer').addEventListener('input', function(event) {
        if (event.target.tagName === 'INPUT' && event.target.name.startsWith('premiseName')) {
            updatePremiseDropdowns();
        }
    });


    document.getElementById('addPremiseBtn').addEventListener('click', () => {
        premiseCount++;
        const container = document.getElementById('premiseContainer');
        const newItem = document.createElement('div');
        newItem.classList.add('premise-item', 'border', 'border-gray-300', 'dark:border-gray-700', 'rounded-md', 'p-4', 'space-y-4', 'mt-4');
        newItem.id = `premise-${premiseCount}`;
        newItem.innerHTML = `
            <div class="flex justify-between items-center">
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">Premise ${premiseCount} - Name</label>
                <button type="button" class="remove-premise-btn ${tailwindRemoveBtnClass}">Remove</button>
            </div>
            <input type="text" name="premiseName${premiseCount}" id="premiseName${premiseCount}" placeholder="Enter premise name" required class="${tailwindInputClass}">
            <input type="text" name="premiseArea${premiseCount}" id="premiseArea${premiseCount}" placeholder="Enter premise area" required class="${tailwindInputClass}">
            <input type="text" name="premiseAddress${premiseCount}" id="premiseAddress${premiseCount}" placeholder="Enter premise address" required class="${tailwindInputClass}">
        `;
        container.appendChild(newItem);
        updatePremiseDropdowns();
    });

    document.getElementById('premiseContainer').addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-premise-btn')) {
            event.target.closest('.premise-item').remove();
            // Renumbering is complex, for now, just remove. Backend needs to handle gaps or re-index.
            updatePremiseDropdowns();
        }
    });

    document.getElementById('addContactBtn').addEventListener('click', () => {
        contactCount++;
        const container = document.getElementById('contactContainer');
        const newItem = document.createElement('div');
        newItem.classList.add('contact-item', 'border', 'border-gray-300', 'dark:border-gray-700', 'rounded-md', 'p-4', 'space-y-4', 'mt-4');
        newItem.id = `contact-${contactCount}`;
        newItem.innerHTML = `
            <div class="flex justify-between items-center">
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">PIC ${contactCount} - Name</label>
                <button type="button" class="remove-contact-btn ${tailwindRemoveBtnClass}">Remove</button>
            </div>
            <input type="text" name="picName${contactCount}" id="picName${contactCount}" placeholder="Enter name" required class="${tailwindInputClass}">
            <input type="text" name="picDesignation${contactCount}" id="picDesignation${contactCount}" placeholder="Enter designation" required class="${tailwindInputClass}">
            <input type="text" name="picContact${contactCount}" id="picContact${contactCount}" placeholder="Enter contact number" required class="${tailwindInputClass}">
            <input type="email" name="picEmail${contactCount}" id="picEmail${contactCount}" placeholder="Enter email" required class="${tailwindInputClass}">
            <div>
                <label for="contactPremise${contactCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tie contact to:</label>
                <select name="contactPremise${contactCount}" id="contactPremise${contactCount}" required class="${tailwindInputClass}">
                    ${getPremiseOptionsHTML()}
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="sameAsAboveContact${contactCount}" data-target="${contactCount}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 same-as-above-contact">
                <label for="sameAsAboveContact${contactCount}" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Same as PIC 1 (if applicable)</label>
            </div>
        `;
        container.appendChild(newItem);
    });

    document.getElementById('contactContainer').addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-contact-btn')) {
            event.target.closest('.contact-item').remove();
        }
    });

    document.getElementById('contactContainer').addEventListener('change', function (event) {
        if (event.target.classList.contains('same-as-above-contact')) {
            const targetIndex = event.target.getAttribute('data-target');
            if (event.target.checked && targetIndex > 1) { // Only if not the first contact
                const firstContactItem = document.getElementById('contact-1');
                if (firstContactItem) {
                    document.getElementById(\`picName\${targetIndex}\`).value = firstContactItem.querySelector('[name="picName1"]').value;
                    document.getElementById(\`picDesignation\${targetIndex}\`).value = firstContactItem.querySelector('[name="picDesignation1"]').value;
                    document.getElementById(\`picContact\${targetIndex}\`).value = firstContactItem.querySelector('[name="picContact1"]').value;
                    document.getElementById(\`picEmail\${targetIndex}\`).value = firstContactItem.querySelector('[name="picEmail1"]').value;
                    document.getElementById(\`contactPremise\${targetIndex}\`).value = firstContactItem.querySelector('[name="contactPremise1"]').value;
                }
            }
        }
    });


    document.getElementById('addDeviceBtn').addEventListener('click', () => {
        deviceCount++;
        const container = document.getElementById('deviceContainer');
        const newItem = document.createElement('div');
        newItem.classList.add('device-item', 'border', 'border-gray-300', 'dark:border-gray-700', 'rounded-md', 'p-4', 'space-y-4', 'mt-4');
        newItem.id = `device-${deviceCount}`;
        let eventHTML = '';
        for (let i = 1; i <= 4; i++) {
            eventHTML += `
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <h5 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-2">Event ${i}</h5>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                    <div>
                        <label for="E${i}Days${deviceCount}" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Days</label>
                        <input type="text" name="E${i}Days${deviceCount}" id="E${i}Days${deviceCount}" placeholder="e.g., Mon-Fri" ${i === 1 ? 'required' : ''} class="${tailwindInputClassXs}">
                    </div>
                    <div>
                        <label for="E${i}StartTime${deviceCount}" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Start Time</label>
                        <input type="text" name="E${i}StartTime${deviceCount}" id="E${i}StartTime${deviceCount}" placeholder="HH:MM" ${i === 1 ? 'required' : ''} class="${tailwindInputClassXs}">
                    </div>
                    <div>
                        <label for="E${i}EndTime${deviceCount}" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">End Time</label>
                        <input type="text" name="E${i}EndTime${deviceCount}" id="E${i}EndTime${deviceCount}" placeholder="HH:MM" ${i === 1 ? 'required' : ''} class="${tailwindInputClassXs}">
                    </div>
                    <div>
                        <label for="E${i}Work${deviceCount}" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Work (s)</label>
                        <input type="number" name="E${i}Work${deviceCount}" id="E${i}Work${deviceCount}" placeholder="e.g., 60" ${i === 1 ? 'required' : ''} class="${tailwindInputClassXs}">
                    </div>
                    <div>
                        <label for="E${i}Pause${deviceCount}" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Pause (s)</label>
                        <input type="number" name="E${i}Pause${deviceCount}" id="E${i}Pause${deviceCount}" placeholder="e.g., 120" ${i === 1 ? 'required' : ''} class="${tailwindInputClassXs}">
                    </div>
                </div>
            </div>`;
        }
        newItem.innerHTML = `
            <div class="flex justify-between items-center">
                <h4 class="text-lg font-medium text-gray-800 dark:text-gray-200">Device ${deviceCount}</h4>
                <button type="button" class="remove-device-btn ${tailwindRemoveBtnClass}">Remove</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <label for="deviceLocation${deviceCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Location</label>
                    <input type="text" name="deviceLocation${deviceCount}" id="deviceLocation${deviceCount}" placeholder="Enter location" required class="${tailwindInputClass}">
                </div>
                <div>
                    <label for="deviceSN${deviceCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">S/N</label>
                    <input type="number" name="deviceSN${deviceCount}" id="deviceSN${deviceCount}" placeholder="Enter serial number" required class="${tailwindInputClass}">
                </div>
                <div>
                    <label for="deviceModel${deviceCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                    <select name="deviceModel${deviceCount}" id="deviceModel${deviceCount}" required class="${tailwindInputClass}">
                        <option value="" selected disabled>Select a model</option>${modelOptions}</select>
                </div>
                <div>
                    <label for="deviceColour${deviceCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Colour</label>
                    <input type="text" name="deviceColour${deviceCount}" id="deviceColour${deviceCount}" placeholder="Enter colour" required class="${tailwindInputClass}">
                </div>
                <div>
                    <label for="deviceVolume${deviceCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Volume Required</label>
                    <input type="number" name="deviceVolume${deviceCount}" id="deviceVolume${deviceCount}" placeholder="Enter volume required" required class="${tailwindInputClass}">
                </div>
                <div>
                    <label for="deviceScent${deviceCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Scent</label>
                    <select name="deviceScent${deviceCount}" id="deviceScent${deviceCount}" required class="${tailwindInputClass}">
                        <option value="" selected disabled>Select a scent</option>${eoOptions}</select>
                </div>
                <div class="md:col-span-2">
                    <label for="devicePremise${deviceCount}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tie Device to Premise:</label>
                    <select name="devicePremise${deviceCount}" id="devicePremise${deviceCount}" required class="${tailwindInputClass}">
                        ${getPremiseOptionsHTML()}
                    </select>
                </div>
            </div>
            ${eventHTML}
        `;
        container.appendChild(newItem);
    });

    document.getElementById('deviceContainer').addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-device-btn')) {
            event.target.closest('.device-item').remove();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const dateInput = document.getElementById('dateCreated');
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }
        // Initial premise dropdown update for contacts and devices
        updatePremiseDropdowns();
    });

    document.getElementById('customerForm').addEventListener('submit', function (event) {
        let isValid = true;
        const requiredFields = document.querySelectorAll('#customerForm [required]');

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                // Add visual indication of error, e.g., border color
                field.classList.add('border-red-500', 'dark:border-red-400');
                field.classList.remove('border-gray-300', 'dark:border-gray-600');
            } else {
                // Remove error indication
                field.classList.remove('border-red-500', 'dark:border-red-400');
                field.classList.add('border-gray-300', 'dark:border-gray-600');
            }
        });

        if (!isValid) {
            event.preventDefault();
            // Optionally, display a general error message
            alert('Please fill out all required fields.');
        }
    });
</script>

{# These script tags are to pass Flask data to JS, keep them at the end of the block or outside if they cause issues with other JS #}
<script id="eoListData" type="application/json">
    {{ essential_oils | tojson | safe }}
</script>
<script id="modelListData" type="application/json">
    {{ models | tojson | safe }}
</script>
{% endblock %}
