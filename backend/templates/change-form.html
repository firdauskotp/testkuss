{% extends "base.html" %}

{% block title %}Change Request Form{% endblock %}
{% block page_title %}Submit Change Request{% endblock %}

{% block head_extra %}
    {# Custom CSS for this page, if any, would go here #}
{% endblock %}

{% block content %}
<div class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto space-y-8">

        <div class="text-left mb-6">
            <a href="{{ url_for('dashboard') }}"
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900">
                &larr; Back to Dashboard
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="space-y-3">
                {% for category, message in messages %}
                <div class="p-4 text-sm rounded-md border
                            {% if category == 'danger' %} bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 border-red-300 dark:border-red-500/50 {% endif %}
                            {% if category == 'success' %} bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-300 dark:border-green-500/50 {% endif %}
                            " role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

        <form id="changeForm" method="POST" action="{{ url_for('forms.change_form') }}" class="space-y-8"
              data-get-premises-url-template="{{ url_for('api_helpers.get_premises', company='__COMPANY__') }}"
              data-get-devices-url-template="{{ url_for('api_helpers.get_devices', premise='__PREMISE__') }}">
            <!-- User and Company -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">User & Company Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="userDisplay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">User</label>
                        <input type="text" id="userDisplay" value="{{ username }}"
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                               disabled>
                    </div>
                    <div>
                        <label for="companyName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company Name</label>
                        <select id="companyName" name="companyName" required
                                class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50">
                            <option value="" disabled selected>Select Company</option>
                            {% for company in companies %}
                                <option value="{{ company }}">{{ company }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="dateDisplay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                        <input type="date" id="dateDisplay" value="{{ current_date }}"
                               class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                               disabled>
                        <input type="hidden" name="date" value="{{ current_date }}">
                    </div>
                </div>
            </div>

            <!-- Change Options -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Change Details</h3>
                <div class="space-y-4">
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="changeScent" name="changeScent" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                        </div>
                        <div class="ml-3 text-sm flex-grow">
                            <label for="changeScent" class="font-medium text-gray-700 dark:text-gray-300">Change scent to</label>
                            <input type="text" name="changeScentText" id="changeScentText" placeholder="New scent" disabled
                                   class="mt-1 appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50 disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:text-gray-400 dark:disabled:text-gray-500">
                        </div>
                    </div>
                    <!-- Repeat for other checkboxes, adapting layout as needed -->
                    {% for item_id, item_name, item_text in [
                        ('redoSettings', 'redoSettings', 'Redo settings'),
                        ('reduceIntensity', 'reduceIntensity', 'Reduce scent intensity'),
                        ('increaseIntensity', 'increaseIntensity', 'Increase scent intensity'),
                        ('collectBack', 'collectBack', 'Collect back machine')
                    ] %}
                    <div class="flex items-center">
                        <input id="{{ item_id }}" name="{{ item_name }}" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                        <label for="{{ item_id }}" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">{{ item_text }}</label>
                    </div>
                    {% endfor %}

                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="moveDevice" name="moveDevice" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                        </div>
                        <div class="ml-3 text-sm flex-grow">
                            <label for="moveDevice" class="font-medium text-gray-700 dark:text-gray-300">Move device to</label>
                            <input type="text" name="moveDeviceText" id="moveDeviceText" placeholder="New location" disabled
                                   class="mt-1 appearance-none block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50 disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:text-gray-400 dark:disabled:text-gray-500">
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="relocateDevice" name="relocateDevice" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:focus:ring-offset-gray-800">
                        </div>
                        <div class="ml-3 text-sm flex-grow">
                            <label for="relocateDevice" class="font-medium text-gray-700 dark:text-gray-300">Relocate device to</label>
                            <select id="relocateDeviceDropdown" name="relocateDeviceDropdown" disabled
                                    class="mt-1 appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50 disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:text-gray-400 dark:disabled:text-gray-500">
                                <option disabled selected>Select Premise</option>
                                {# Premises options will be populated by JS or need to be pre-filled if static #}
                                {% for premise in premises %} {# Assuming 'premises' is available for this dropdown too #}
                                  <option value="{{ premise }}">{{ premise }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="remark" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Remark</label>
                        <textarea name="remark" id="remark" rows="3" required
                                  class="appearance-none block w-full px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700/50 text-gray-900 dark:text-gray-50"></textarea>
                    </div>
                </div>
            </div>

            <!-- Month/Year -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Effective Month/Year</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="month" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Month</label>
                        <select name="month" id="month" class="tailwind-input-class"> {# Using the common input class for select #}
                            {% for m_idx, m_name in [ (1,'JAN'),(2,'FEB'),(3,'MAR'),(4,'APR'),(5,'MAY'),(6,'JUN'),(7,'JUL'),(8,'AUG'),(9,'SEP'),(10,'OCT'),(11,'NOV'),(12,'DEC') ] %}
                                <option value="{{ m_idx }}">{{ m_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year</label>
                                                {% set year_for_range = 2024 %} {# Default year #}
                        
                        {% if current_date is defined and current_date %}
                            {% if current_date is string %}
                                {# current_date is a string. Try to extract year from its beginning. #}
                                {# For example, if current_date is "2025" or "2025-01-10" #}
                                {% set extracted_year_str = current_date[:4] %}
                                {% set converted_year = extracted_year_str | int(0) %} {# Convert to int, default to 0 on failure #}
                                {% if converted_year > 1900 and converted_year < 2200 %} {# Basic sanity check for a plausible year #}
                                    {% set year_for_range = converted_year %}
                                {% endif %}
                            {% elif hasattr(current_date, 'year') and current_date.year is number %}
                                {# current_date is an object (e.g., datetime) with a numeric .year attribute #}
                                {% set year_for_range = current_date.year %}
                            {% endif %}
                        {% endif %}
                        
                        {% for y in range(year_for_range, year_for_range + 6) %}
                            {# Your content for each year 'y' goes here. For example: #}
                            <option value="{{ y }}">{{ y }}</option>
                        {% endfor %}
                      
                        
                    </div>
                </div>
            </div>

            <!-- Premises and Devices -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6 sm:p-8">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-6 border-b border-gray-300 dark:border-gray-700 pb-3">Affected Premises & Devices</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Premises</label>
                    <div id="premises-container" class="space-y-2 p-3 border border-gray-200 dark:border-gray-700 rounded-md min-h-[50px]">
                        {# Premises checkboxes will be loaded here by JS #}
                        <p class="text-xs text-gray-500 dark:text-gray-400">Select a company to load premises.</p>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Devices</label>
                    <div id="devices-container" class="space-y-2 p-3 border border-gray-200 dark:border-gray-700 rounded-md min-h-[50px]">
                        {# Devices checkboxes will be loaded here by JS #}
                        <p class="text-xs text-gray-500 dark:text-gray-400">Select premises to load devices.</p>
                    </div>
                </div>
                <div id="eo-container" class="mt-4 p-3 border border-dashed border-gray-300 dark:border-gray-600 rounded-md min-h-[40px]">
                     <p class="text-xs text-gray-500 dark:text-gray-400">Detected essential oils will appear here.</p>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button type="submit"
                        class="py-2.5 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white
                               bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600
                               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:focus:ring-offset-gray-900">
                    Submit Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const changeForm = document.getElementById('changeForm');
    const getPremisesUrlTemplate = changeForm.dataset.getPremisesUrlTemplate;
    const getDevicesUrlTemplate = changeForm.dataset.getDevicesUrlTemplate;

    const companySelect = document.getElementById("companyName");
    const premisesContainer = document.getElementById("premises-container");
    const devicesContainer = document.getElementById("devices-container");
    const eoContainer = document.getElementById("eo-container");

    // Common Tailwind class for dynamically added checkboxes and their labels
    const checkboxWrapperClass = "flex items-center space-x-2 p-1.5 rounded hover:bg-gray-50 dark:hover:bg-gray-700";
    const checkboxInputClass = "h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 dark:focus:ring-offset-gray-800";
    const checkboxLabelClass = "text-sm font-medium text-gray-700 dark:text-gray-300";

    companySelect.addEventListener("change", () => {
        const company = companySelect.value;
        premisesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Loading premises...</p>'; // Clear previous
        devicesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Select premises to load devices.</p>'; // Clear previous
        eoContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Detected essential oils will appear here.</p>'; // Clear previous

        if (!company) {
            premisesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Select a company to load premises.</p>';
            return;
        }

        // Fetch HTML for premises checkboxes (assuming the endpoint returns pre-styled HTML or simple structure)
        fetch(getPremisesUrlTemplate.replace('__COMPANY__', encodeURIComponent(company)))
            .then(res => res.text())
            .then(html => {
                premisesContainer.innerHTML = html; // This HTML might need to be Tailwind-styled at its source or here
                // If the fetched HTML is raw, you might need to parse it and add classes.
                // For now, assuming it's either pre-styled or simple enough.
                // Example of adding classes if it was just a list of divs with inputs/labels:
                premisesContainer.querySelectorAll('.form-check').forEach(el => { // If old Bootstrap classes were used
                    el.className = checkboxWrapperClass; // Replace class
                    el.querySelector('input').classList.add(...checkboxInputClass.split(' '));
                    el.querySelector('label').classList.add(...checkboxLabelClass.split(' '));
                });
                hookPremiseListeners();
            })
            .catch(err => {
                premisesContainer.innerHTML = '<p class="text-xs text-red-500 dark:text-red-400">Error loading premises.</p>';
                console.error("Error fetching premises:", err);
            });
    });

    function hookPremiseListeners() {
        document.querySelectorAll(".premise-checkbox").forEach(premiseCheckbox => {
            premiseCheckbox.addEventListener("change", updateDeviceList);
        });
        updateDeviceList(); // Initial call in case some premises are pre-selected (if form remembers state)
    }

    function updateDeviceList() {
        devicesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Loading devices...</p>';
        eoContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Detected essential oils will appear here.</p>';

        const selectedPremises = Array.from(document.querySelectorAll(".premise-checkbox:checked")).map(cb => cb.value);

        if (selectedPremises.length === 0) {
            devicesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Select premises to load devices.</p>';
            return;
        }

        // For simplicity, let's assume we fetch all devices for selected premises
        // and then filter/display. A more optimized way might involve separate fetches per premise if needed.
        // This example fetches devices for the first selected premise for simplicity, adjust if needed.
        // Or, modify the backend to accept a list of premises.
        // For this example, let's just use the first selected premise to trigger device loading.
        // A better approach would be to aggregate devices from all selected premises.

        // This part needs careful handling based on how /get-devices works.
        // Assuming /get-devices can take ONE premise and we show devices from ALL selected premises.
        // This requires multiple fetches or a backend that handles arrays of premises.
        // For now, let's clear and repopulate:

        devicesContainer.innerHTML = ''; // Clear before populating

        let deviceFetchPromises = selectedPremises.map(premise => {
            return fetch(getDevicesUrlTemplate.replace('__PREMISE__', encodeURIComponent(premise)))
                .then(res => res.json())
                .then(data => ({ premise, devices: data.devices }))
                .catch(err => { console.error(`Error fetching devices for ${premise}:`, err); return { premise, devices: [] }; });
        });

        Promise.all(deviceFetchPromises).then(results => {
            devicesContainer.innerHTML = ''; // Clear loading message
            let totalDevices = 0;
            results.forEach(result => {
                if (result.devices.length > 0) {
                    const premiseHeader = document.createElement('h6');
                    premiseHeader.className = 'text-sm font-medium text-gray-600 dark:text-gray-400 mt-2 col-span-full'; // Use col-span-full if in grid
                    premiseHeader.textContent = `Devices in ${result.premise}:`;
                    devicesContainer.appendChild(premiseHeader);
                }
                result.devices.forEach((device, i) => {
                    totalDevices++;
                    const div = document.createElement("div");
                    div.className = checkboxWrapperClass;

                    const input = document.createElement("input");
                    input.type = "checkbox";
                    input.className = checkboxInputClass;
                    input.name = "devices"; // All selected devices will have this name
                    input.id = `device_${result.premise.replace(/\s+/g, '-')}_${i}`; // Unique ID
                    input.value = device; // Assuming device is a string (name/ID)

                    const label = document.createElement("label");
                    label.className = checkboxLabelClass;
                    label.htmlFor = input.id;
                    label.textContent = device;

                    div.appendChild(input);
                    div.appendChild(label);
                    devicesContainer.appendChild(div);
                });
            });
            if(totalDevices === 0) {
                 devicesContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No devices found for selected premises.</p>';
            }
            hookDeviceEOListener();
        });
    }


    function hookDeviceEOListener() {
        // Remove previous listeners to avoid multiple calls if this function is called multiple times
        const newDevicesContainer = devicesContainer.cloneNode(true);
        devicesContainer.parentNode.replaceChild(newDevicesContainer, devicesContainer);
        devicesContainer = newDevicesContainer; // Update reference

        devicesContainer.addEventListener("change", (event) => {
            if (event.target.classList.contains('device-checkbox') || event.target.name === 'devices') {
                const selectedDevices = Array.from(document.querySelectorAll("input[name='devices']:checked")).map(cb => cb.value);

                if (selectedDevices.length === 0) {
                    eoContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Detected essential oils will appear here.</p>';
                    return;
                }
                eoContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">Loading EOs...</p>';

                fetch("{{ url_for('api_helpers.get_eos') }}", { // Using url_for for the endpoint
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ devices: selectedDevices })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.eos && data.eos.length > 0) {
                        eoContainer.innerHTML = `<strong class="text-sm text-gray-700 dark:text-gray-300">Detected Essential Oils:</strong><ul class="list-disc list-inside pl-2 mt-1">` +
                        data.eos.map(eo => `<li class="text-xs text-gray-600 dark:text-gray-400">${eo}</li>`).join('') + `</ul>`;
                    } else {
                        eoContainer.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No specific EOs detected for selected devices.</p>';
                    }
                })
                .catch(err => {
                    eoContainer.innerHTML = '<p class="text-xs text-red-500 dark:text-red-400">Error loading EOs.</p>';
                    console.error("Error fetching EOs:", err);
                });
            }
        });
    }

    // Enable/disable conditional inputs
    const conditionalInputs = [
        { checkboxId: "changeScent", inputId: "changeScentText" },
        { checkboxId: "moveDevice", inputId: "moveDeviceText" },
        { checkboxId: "relocateDevice", inputId: "relocateDeviceDropdown" }
    ];
    conditionalInputs.forEach(item => {
        const checkbox = document.getElementById(item.checkboxId);
        const inputElement = document.getElementById(item.inputId);
        if (checkbox && inputElement) {
            checkbox.addEventListener("change", function () {
                inputElement.disabled = !this.checked;
                if (!this.checked) inputElement.value = ''; // Clear value when disabled
            });
            // Initial state
            inputElement.disabled = !checkbox.checked;
        }
    });

    const collectBack = document.getElementById("collectBack");
    const allChangeOptionCheckboxes = document.querySelectorAll('#changeForm input[type="checkbox"]'); // More specific selector

    if (collectBack) {
        collectBack.addEventListener("change", () => {
            allChangeOptionCheckboxes.forEach(cb => {
                // Disable other change options if collectBack is checked, but not premise/device selectors
                if (cb !== collectBack && !cb.classList.contains("premise-checkbox") && !cb.classList.contains("device-checkbox") && cb.closest('.bg-white')) {
                    cb.disabled = collectBack.checked;
                    if (collectBack.checked) cb.checked = false; // Uncheck others if collect back is chosen
                    // Also disable associated text inputs/selects
                    const associatedInputId = conditionalInputs.find(item => item.checkboxId === cb.id)?.inputId;
                    if (associatedInputId) {
                        const associatedInput = document.getElementById(associatedInputId);
                        if (associatedInput) {
                            associatedInput.disabled = true;
                            associatedInput.value = '';
                        }
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}
